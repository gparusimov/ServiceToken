version: 0.2

env:
    variables:
        S3_BUCKET: "flexitimetoken"
        BUILD_ENV: "dev"
    parameter-store:
        PROVIDER_URL: "Infura_Rinkeby_Key"
        WALLET_MNEMONIC: "HDWallet_Mnemonic"
phases:
    install:
        commands:
            # Token replacement so truffle can use our Infura  provider URL
            # which we don't want to commit to GitHub
            - sed "s@RINKEBY_PROVIDER_URL@${PROVIDER_URL}@g" truffle.js > truffle.js.tmp
            - mv truffle.js.tmp truffle.js

            - sed "s@MNEMONIC@${WALLET_MNEMONIC}@g" truffle.js > truffle.js.tmp
            - mv truffle.js.tmp truffle.js

            - cat truffle.js

            - echo Installing source NPM dependencies...
            - npm install
            - npm install -g @angular/cli
            - npm install -g truffle@3.4.11  #This version until we solve the gas limit issue
    build:
        commands:
            - echo Build started on `date`

            # Compile our contracts
            - truffle compile

            # Migrate aka deploy our contracts to the chain
            - truffle migrate --network "rinkeby"

            # Build the webapp 
            - ng build --env=$BUILD_ENV

            # Copy the compiled contracts into the distribution
            # so all DApp dependencies are satisfied
            - cp -pR build dist

    post_build:
         commands:
            # Put our webapp into S3 bucket
            - aws s3 cp dist s3://$S3_BUCKET --recursive

            - echo Build completed on `date`
artifacts:
    files:
        - '**/*'
    base-directory: 'dist*'
    discard-paths: yes
